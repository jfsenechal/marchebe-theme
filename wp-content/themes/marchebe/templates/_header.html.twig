<!-- Main Header -->
<nav class="fixed top-0 left-0 w-full z-50"
        @click.window="closeOnClickOutside($event)"
     x-data="{
    // State Management
    isMobileMenuOpen: false,
    activeMobileDrawerId: null,
    isDesktopMenuOpen: false,
    activeDesktopCategory: null,
    isSearchModalOpen: false,
    searchQuery: '',
    results: [],
    isLoading: false,
    error: '',
    // Keyboard navigation state
    focusedCategoryIndex: 0,
    focusedChildIndex: 0,
    focusContext: 'categories',
    // Init
    init() {
        // Listen for CTRL + K to open search modal
        window.addEventListener('keydown', (event) => {
            if ((event.ctrlKey || event.metaKey) && event.key === 'k') {
                event.preventDefault();
                this.openSearchModal();
            }
            // Listen for ESC to close search modal
            if (event.key === 'Escape' && this.isSearchModalOpen) {
                this.closeSearchModal();
            }
        });
    },
    // Computed
    get activeMobileCategoryData() {
        if (!this.activeMobileDrawerId || !this.menuData) return null;
        return this.menuData.find(item => item.blogid === this.activeMobileDrawerId);
    },
    // Methods
    toggleMobileMenu() {
        this.isMobileMenuOpen = !this.isMobileMenuOpen;
        if (!this.isMobileMenuOpen) {
            setTimeout(() => {
                this.activeMobileDrawerId = null;
            }, 300);
        }
    },

    toggleDesktopMenu() {
        this.isDesktopMenuOpen = !this.isDesktopMenuOpen;
        if (this.isDesktopMenuOpen) {
            this.resetDesktopMenuFocus();
            // Select first category by default
            if (this.menuData.length > 0) {
                this.selectDesktopCategory(this.menuData[0]);
            }
            this.$nextTick(() => {
                this.focusCategoryButton(0);
            });
        }
    },

    openMobileDrawer(id) {
        this.activeMobileDrawerId = id;
    },

    closeMobileDrawer() {
        this.activeMobileDrawerId = null;
    },

    selectDesktopCategory(category) {
        this.activeDesktopCategory = category;
    },

    openSearchModal() {
      this.isSearchModalOpen = true;
      },

    closeSearchModal() {
        this.isSearchModalOpen = false;
        this.searchQuery = '';
        this.results = [];
        this.error = '';
    },

    closeOnClickOutside(event) {
        if (!this.isDesktopMenuOpen) return;

        const button = this.$refs.desktopMenuButton;
        const panel = this.$refs.desktopMenuPanel;

        const isClickOnButton = button && button.contains(event.target);
        const isClickInsidePanel = panel && panel.contains(event.target);

        if (!isClickOnButton && !isClickInsidePanel) {
            this.isDesktopMenuOpen = false;
        }
    },

    // Keyboard navigation methods
    handleDesktopMenuKeydown(event) {
        if (!this.isDesktopMenuOpen) return;

        const key = event.key;

        // Close menu on Escape
        if (key === 'Escape') {
            event.preventDefault();
            this.isDesktopMenuOpen = false;
            this.$refs.desktopMenuButton?.focus();
            return;
        }

        // Handle arrow keys
        if (this.focusContext === 'categories') {
            if (key === 'ArrowDown') {
                event.preventDefault();
                this.navigateCategories(1);
            } else if (key === 'ArrowUp') {
                event.preventDefault();
                this.navigateCategories(-1);
            } else if (key === 'ArrowRight' && this.activeDesktopCategory?.items?.length > 0) {
                event.preventDefault();
                this.moveToChildren();
            } else if (key === 'Enter' || key === ' ') {
                event.preventDefault();
                this.activateFocusedCategory();
            }
        } else if (this.focusContext === 'children') {
            if (key === 'ArrowDown') {
                event.preventDefault();
                this.navigateChildren(1);
            } else if (key === 'ArrowUp') {
                event.preventDefault();
                this.navigateChildren(-1);
            } else if (key === 'ArrowLeft') {
                event.preventDefault();
                this.moveToCategories();
            }
        }
    },

    navigateCategories(direction) {
        const maxIndex = this.menuData.length - 1;
        this.focusedCategoryIndex = Math.max(0, Math.min(maxIndex, this.focusedCategoryIndex + direction));
        this.focusCategoryButton(this.focusedCategoryIndex);
        // Auto-select category on navigation
        this.selectDesktopCategory(this.menuData[this.focusedCategoryIndex]);
    },

    navigateChildren(direction) {
        if (!this.activeDesktopCategory?.items) return;
        const maxIndex = this.activeDesktopCategory.items.length - 1;
        this.focusedChildIndex = Math.max(0, Math.min(maxIndex, this.focusedChildIndex + direction));
        this.focusChildLink(this.focusedChildIndex);
    },

    moveToChildren() {
        if (!this.activeDesktopCategory?.items?.length) return;
        this.focusContext = 'children';
        this.focusedChildIndex = 0;
        this.$nextTick(() => {
            this.focusChildLink(0);
        });
    },

    moveToCategories() {
        this.focusContext = 'categories';
        this.$nextTick(() => {
            this.focusCategoryButton(this.focusedCategoryIndex);
        });
    },

    focusCategoryButton(index) {
        const buttons = this.$refs.desktopMenuPanel?.querySelectorAll('[data-category-index]');
        if (buttons && buttons[index]) {
            buttons[index].focus();
        }
    },

    focusChildLink(index) {
        const links = this.$refs.desktopMenuPanel?.querySelectorAll('[data-child-index]');
        if (links && links[index]) {
            links[index].focus();
        }
    },

    activateFocusedCategory() {
        if (this.menuData[this.focusedCategoryIndex]) {
            this.selectDesktopCategory(this.menuData[this.focusedCategoryIndex]);
        }
    },

    resetDesktopMenuFocus() {
        this.focusedCategoryIndex = 0;
        this.focusedChildIndex = 0;
        this.focusContext = 'categories';
    },
    menuData: {{ menu_data }}
    }">
    <!-- Skip to main content link for accessibility -->
    <a href="#main-content"
       class="sr-only focus:not-sr-only focus:absolute focus:top-0 focus:left-0 focus:z-50 focus:bg-cta-dark focus:text-white focus:p-4 focus:m-2 focus:rounded">
        Aller au contenu principal
    </a>

    <header class="bg-white shadow-md relative z-40" id="main-header">
        <div class="container mx-auto px-4">
            <div class="flex items-center justify-between h-16">
                <a href="/" class="">
                    <img src="{{ template_directory }}/assets/images/img_logo.png"
                         alt="Ville de Marche-en-Famenne"
                         class="h-10 w-16 xl:h-14 xl:w-24"/>
                </a>

                <!-- Desktop Menu Trigger -->
                <div class="hidden md:flex flex-row items-center justify-center space-x-6">
                    <button
                            x-ref="desktopMenuButton"
                            @click="toggleDesktopMenu()"
                            type="button"
                            class="flex flex-row items-center justify-center gap-2 h-16 cursor-pointer font-semibold text-cta-dark hover:text-cta-light transition-colors border-b-3 border-transparent hover:border-b-3 hover:border-cta-light leading-6 focus:outline-none focus-visible:ring-2 focus-visible:ring-offset-2 focus-visible:ring-offset-gray-800 focus-visible:ring-white"
                            :aria-expanded="isDesktopMenuOpen"
                            aria-controls="desktop-menu"
                    >
                        <i class="fas fa-bars" aria-hidden="true"></i> <span>Vivre Ã  Marche</span>
                    </button>
                    {% include '@AcMarche/navigation/_shortcuts.html.twig' %}
                </div>
                <!-- Mobile Menu Trigger (Hamburger) -->
                {% include '@AcMarche/navigation/_mobile_vivre_button.html.twig' %}
                {% include '@AcMarche/navigation/_social_icons.html.twig' %}
            </div>
        </div>
        <!-- Search modal-->
        {% include '@AcMarche/search/_modal.html.twig' %}
    </header>
    <!-- Desktop Menu Panel -->
    {% include '@AcMarche/navigation/_desktop_menu.html.twig' %}
    {# Mobile Menu Panel #}
    {% include '@AcMarche/navigation/_mobile_menu.html.twig' %}
    {% include '@AcMarche/footer/_bottom_navigation.html.twig' %}
</nav>
{% include '@AcMarche/widgets/_cookies.html.twig' %}